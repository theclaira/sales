<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Race to the Summit</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <style>
        /* ... your full CSS unchanged ... */
        body { font-family: 'Segoe UI', Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: linear-gradient(135deg, #4b0082, #00b7eb); color: #ffffff; text-align: center; }
        h1, h2, h3 { color: #ffeb3b; }
        select, input, button { padding: 10px; margin: 5px; border: none; border-radius: 5px; font-size: 16px; }
        select { background: #ff69b4; color: #fff; }
        input { background: #e0ffff; color: #333; }
        button { background: #32cd32; color: #fff; cursor: pointer; transition: background 0.3s; }
        button:hover { background: #228b22; }
        #map-container { position: relative; height: 300px; margin: 20px auto; overflow: hidden; width: 100%; }
        #map-canvas { width: 100%; height: 100%; background: linear-gradient(to bottom, #87ceeb, #228b22); }
        #progress-path-mitch { stroke: #ff4500; stroke-width: 10; fill: none; transition: stroke-dashoffset 0.5s; }
        #progress-path-paul { stroke: #00b7eb; stroke-width: 10; fill: none; transition: stroke-dashoffset 0.5s; }
        #progress-path-guest { stroke: #ffeb3b; stroke-width: 10; fill: none; transition: stroke-dashoffset 0.5s; }
        #progress-path-pauline { stroke: #ff69b4; stroke-width: 10; fill: none; transition: stroke-dashoffset 0.5s; }
        #road { stroke: #808080; stroke-width: 20; fill: none; stroke-linecap: round; }
        .marker { position: absolute; font-size: 24px; }
        #present { position: absolute; font-size: 30px; right: 10px; top: 190px; }
        .milestone { position: absolute; font-size: 20px; }
        #prize { display: none; margin: 20px auto; padding: 15px; background: #ff69b4; border: 2px solid #ffd700; border-radius: 10px; color: #fff; width: fit-content; }
        #sales-list { margin-top: 10px; background: rgba(255, 255, 255, 0.2); padding: 10px; border-radius: 5px; text-align: left; }
        #sales-list li { color: #e0ffff; margin: 5px 0; }
        #leaderboard { margin-top: 20px; background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 5px; text-align: left; }
        #leaderboard table { width: 100%; border-collapse: collapse; color: #e0ffff; }
        #leaderboard th, #leaderboard td { padding: 8px; border: 1px solid #ffd700; }
        #leaderboard th { background: #ff69b4; }
        #quests { margin-top: 20px; background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 5px; text-align: left; color: #e0ffff; }
        #quests ul li.completed { color: #32cd32; text-decoration: line-through; }
        #how-to-play { margin-top: 20px; background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 5px; text-align: left; color: #e0ffff; }
        #how-to-play h3 { margin-top: 0; }
    </style>
</head>
<body>
    <!-- ... Your full HTML layout unchanged ... -->
    <h1>Sales Race to the Summit</h1>
    <div>
        <label for="name">Select Your Name:</label>
        <select id="name">
            <option value="">-- Choose Name --</option>
            <option value="Mitch">Mitch</option>
            <option value="Paul">Paul</option>
            <option value="Guest">Guest</option>
            <option value="Pauline">Pauline</option>
        </select>
    </div>
    <div style="margin-top: 20px;">
        <label for="donor-age">Enter Donor Age for Sale:</label>
        <input type="number" id="donor-age" min="1" placeholder="Age">
        <button onclick="addSale()">Add Sale</button>
    </div>
    <div id="map-container">
        <svg id="map-canvas" viewBox="0 0 800 300">
            <path id="road" d="M 50 250 Q 100 100 200 200 Q 300 300 400 200 Q 500 100 600 200 Q 650 250 700 200 Q 750 150 750 200" stroke="#808080" stroke-width="20" fill="none" stroke-linecap="round"/>
            <path id="progress-path-mitch" d="M 50 250 Q 100 100 200 200 Q 300 300 400 200 Q 500 100 600 200 Q 650 250 700 200 Q 750 150 750 200" stroke-dasharray="0" stroke-dashoffset="0"/>
            <path id="progress-path-paul" d="M 50 250 Q 100 100 200 200 Q 300 300 400 200 Q 500 100 600 200 Q 650 250 700 200 Q 750 150 750 200" stroke-dasharray="0" stroke-dashoffset="0"/>
            <path id="progress-path-guest" d="M 50 250 Q 100 100 200 200 Q 300 300 400 200 Q 500 100 600 200 Q 650 250 700 200 Q 750 150 750 200" stroke-dasharray="0" stroke-dashoffset="0"/>
            <path id="progress-path-pauline" d="M 50 250 Q 100 100 200 200 Q 300 300 400 200 Q 500 100 600 200 Q 650 250 700 200 Q 750 150 750 200" stroke-dasharray="0" stroke-dashoffset="0"/>
            <circle cx="200" cy="200" r="10" fill="#ffd700" />
            <circle cx="400" cy="200" r="10" fill="#ffd700" />
            <circle cx="600" cy="200" r="10" fill="#ffd700" />
        </svg>
        <div id="marker-mitch" class="marker">üòé</div>
        <div id="marker-paul" class="marker">üßô</div>
        <div id="marker-guest" class="marker">üêâ</div>
        <div id="marker-pauline" class="marker">ü¶∏</div>
        <div id="present">üéÅ</div>
        <div class="milestone" style="left: 190px; top: 180px;">üåü</div>
        <div class="milestone" style="left: 390px; top: 180px;">üèÜ</div>
        <div class="milestone" style="left: 590px; top: 180px;">üí∞</div>
    </div>
    <div id="prize"><h3>Congratulations! You've reached the end!</h3><p>Your prize is: Tristan cooking something of your choice! üéâ</p></div>
    <div id="leaderboard">
        <h3>Leaderboard</h3>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Sales Count</th>
                    <th>Average Donor Age</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body"></tbody>
        </table>
    </div>
    <div id="quests">
        <h3>Quests</h3>
        <ul id="quest-list">
            <li id="quest-5-sales">Log 3 sales before 12:00 PM</li>
            <li id="quest-first-sale">Make the first sale of the day</li>
            <li id="quest-age-streak">2-day streak with average donor age over 40</li>
        </ul>
    </div>
    <div id="how-to-play">
        <h3>How to Play</h3>
        <p>Welcome, this is going to be a lil journey. A game. A glorious sales race to the mysterious prize at the end. üéÅ</p>
        <p>Here‚Äôs how to play:</p>
        <ul>
            <li><strong>Select Your Name:</strong> Pretty straight forward, can't get this wrong I don't think</li>
            <li><strong>Enter Donor Age:</strong> Pop in the age of your donor. The older they are, the better your score.</li>
            <li><strong>Add Sale:</strong> Tap ‚ÄúAdd Sale‚Äù like you just nailed your pitch. Because you did.</li>
            <li><strong>Track Progress:</strong> You‚Äôll see yourself scooting along a little road map. It‚Äôs bendy, it‚Äôs cute, it‚Äôs your new best friend. Your progress is based on sales, donor age, and side quests completed.</li>
            <li><strong>Milestones:</strong> Hit exciting little markers on your way to greatness: üåü, üèÜ, üí∞.</li>
            <li><strong>Reach the Prize:</strong> When your progress hits 100%, the üéÅ unlocks. What is it? We're not telling. That's how surprises work silly</li>
            <li><strong>Complete Quests:</strong> Quests reset daily, giving you fresh chances to earn bonus points each day. They get you to that prize quicker!</li>
        </ul>
    </div>
    <h3>Sales Log:</h3>
    <ul id="sales-list"></ul>
    <script>
        // -- SheetDB Integration --
        const API_URL = "https://sheetdb.io/api/v1/clmg88cqqdmcj";
        let sales = [];
        let firstSaleToday = {};
        let questCompletion = {
            fiveSales: { Mitch: {}, Paul: {}, Guest: {}, Pauline: {} },
            firstSale: {},
            ageStreak: { Mitch: {}, Paul: {}, Guest: {}, Pauline: {} }
        };

        // Load sales from Google Sheets (SheetDB)
        async function loadSalesFromSheetDB() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                const rows = Array.isArray(data) ? data : [data];
                sales = rows.map(row => ({
                    name: row.Name,
                    age: parseInt(row.SaleAmount),
                    timestamp: new Date(row.Timestamp)
                }));
                updateSalesList();
                updateProgress();
                updateLeaderboard();
            } catch (e) {
                alert("Error loading sales from Google Sheets: " + e.message);
                console.error("SheetDB fetch error:", e);
            }
        }

        // Add sale to Google Sheets (SheetDB)
        async function addSaleToSheetDB(sale) {
            const payload = {
                Name: sale.name,
                SaleAmount: sale.age,
                Timestamp: sale.timestamp.toISOString()
            };
            try {
                const res = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ data: [payload] })
                });
                if (res.ok) {
                    await loadSalesFromSheetDB();
                } else {
                    alert("Error recording sale.");
                }
            } catch (err) {
                alert("Network error recording sale.");
            }
        }

        // --- All your original code below, but addSale now uses SheetDB ---
        const goal = 3000;
        const path = document.getElementById('road');
        const pathLength = path.getTotalLength();
        const milestonePoints = [25, 50, 75];
        const progressPaths = {
            mitch: document.getElementById('progress-path-mitch'),
            paul: document.getElementById('progress-path-paul'),
            guest: document.getElementById('progress-path-guest'),
            pauline: document.getElementById('progress-path-pauline')
        };
        const markers = {
            mitch: document.getElementById('marker-mitch'),
            paul: document.getElementById('marker-paul'),
            guest: document.getElementById('marker-guest'),
            pauline: document.getElementById('marker-pauline')
        };
        const lastProgressPercent = { mitch: 0, paul: 0, guest: 0, pauline: 0 };

        // Initialize progress paths
        Object.values(progressPaths).forEach(p => {
            p.style.strokeDasharray = pathLength;
            p.style.strokeDashoffset = pathLength;
        });

        function addSale() {
            const ageInput = document.getElementById('donor-age');
            const age = parseInt(ageInput.value);
            const name = document.getElementById('name').value;

            if (!name) {
                alert('Please select your name first.');
                return;
            }
            if (isNaN(age) || age <= 0) {
                alert('Please enter a valid donor age.');
                return;
            }

            const now = new Date();
            const aedtOffset = 11 * 60;
            const localTime = new Date(now.getTime() + (aedtOffset * 60 * 1000));
            const sale = { name, age, timestamp: localTime };

            addSaleToSheetDB(sale);
            ageInput.value = '';
            // Updates will trigger from loadSalesFromSheetDB
        }

        function updateSalesList() {
            const list = document.getElementById('sales-list');
            list.innerHTML = '';
            sales.forEach((sale, index) => {
                const li = document.createElement('li');
                li.textContent = `Sale ${index + 1}: ${sale.name} - Donor Age: ${sale.age} (Time: ${sale.timestamp.toLocaleTimeString('en-AU', { timeZone: 'Australia/Sydney' })})`;
                list.appendChild(li);
            });
        }

        function updateProgress() {
            if (sales.length === 0) return;

            const stats = {};
            sales.forEach(sale => {
                const lowerName = sale.name.toLowerCase();
                if (!stats[lowerName]) {
                    stats[lowerName] = { count: 0, totalAge: 0, salesBeforeNoon: {}, dailySales: {} };
                }
                stats[lowerName].count += 1;
                stats[lowerName].totalAge += sale.age;
                const saleDate = sale.timestamp.toLocaleDateString('en-AU', { timeZone: 'Australia/Sydney' });
                if (sale.timestamp.getHours() < 12) {
                    if (!stats[lowerName].salesBeforeNoon[saleDate]) {
                        stats[lowerName].salesBeforeNoon[saleDate] = 0;
                    }
                    stats[lowerName].salesBeforeNoon[saleDate] += 1;
                }
                if (!stats[lowerName].dailySales[saleDate]) {
                    stats[lowerName].dailySales[saleDate] = { totalAge: 0, count: 0 };
                }
                stats[lowerName].dailySales[saleDate].totalAge += sale.age;
                stats[lowerName].dailySales[saleDate].count += 1;
            });

            Object.keys(progressPaths).forEach(lowerName => {
                let points = 0;
                if (stats[lowerName]) {
                    const avgAge = stats[lowerName].totalAge / stats[lowerName].count;
                    points = stats[lowerName].count * avgAge;
                    const today = new Date().toLocaleDateString('en-AU', { timeZone: 'Australia/Sydney' });
                    const playerName = lowerName.charAt(0).toUpperCase() + lowerName.slice(1);
                    const completedQuests = (stats[lowerName].salesBeforeNoon[today] >= 5 ? 1 : 0) +
                        (firstSaleToday[today] && firstSaleToday[today].name.toLowerCase() === lowerName ? 1 : 0) +
                        (questCompletion.ageStreak[playerName][today] ? 1 : 0);
                    points += completedQuests * 10;
                }

                const progressPercent = Math.min((points / goal) * 100, 100);
                const dashOffset = pathLength * (1 - progressPercent / 100);
                progressPaths[lowerName].style.strokeDashoffset = dashOffset;

                milestonePoints.forEach(point => {
                    if (lastProgressPercent[lowerName] < point && progressPercent >= point) {
                        confetti({
                            particleCount: 100,
                            spread: 70,
                            origin: { y: 0.6 }
                        });
                    }
                });
                lastProgressPercent[lowerName] = progressPercent;

                const progressFraction = progressPercent / 100;
                const point = path.getPointAtLength(progressFraction * pathLength);
                markers[lowerName].style.left = `${point.x}px`;
                markers[lowerName].style.top = `${point.y}px`;

                if (progressPercent >= 100) {
                    document.getElementById('prize').style.display = 'block';
                    confetti({
                        particleCount: 200,
                        spread: 100,
                        origin: { y: 0.6 }
                    });
                }
            });
        }

        function updateLeaderboard() {
            const leaderboardBody = document.getElementById('leaderboard-body');
            leaderboardBody.innerHTML = '';

            const stats = {};
            sales.forEach(sale => {
                const lowerName = sale.name.toLowerCase();
                if (!stats[lowerName]) {
                    stats[lowerName] = { count: 0, totalAge: 0, salesBeforeNoon: {}, dailySales: {} };
                }
                stats[lowerName].count += 1;
                stats[lowerName].totalAge += sale.age;
                const saleDate = sale.timestamp.toLocaleDateString('en-AU', { timeZone: 'Australia/Sydney' });
                if (sale.timestamp.getHours() < 12) {
                    if (!stats[lowerName].salesBeforeNoon[saleDate]) {
                        stats[lowerName].salesBeforeNoon[saleDate] = 0;
                    }
                    stats[lowerName].salesBeforeNoon[saleDate] += 1;
                }
                if (!stats[lowerName].dailySales[saleDate]) {
                    stats[lowerName].dailySales[saleDate] = { totalAge: 0, count: 0 };
                }
                stats[lowerName].dailySales[saleDate].totalAge += sale.age;
                stats[lowerName].dailySales[saleDate].count += 1;
            });

            const today = new Date().toLocaleDateString('en-AU', { timeZone: 'Australia/Sydney' });
            const leaderboard = Object.keys(stats).map(lowerName => {
                const name = lowerName.charAt(0).toUpperCase() + lowerName.slice(1);
                const avgAge = stats[lowerName].totalAge / stats[lowerName].count;
                return {
                    name,
                    count: stats[lowerName].count,
                    avgAge
                };
            }).sort((a, b) => b.count - a.count || b.avgAge - a.avgAge);

            leaderboard.forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${entry.name}</td>
                    <td>${entry.count}</td>
                    <td>${entry.avgAge.toFixed(1)}</td>
                `;
                leaderboardBody.appendChild(row);
            });
        }

        function updateQuests(sale) {
            const now = sale.timestamp;
            const date = now.toLocaleDateString('en-AU', { timeZone: 'Australia/Sydney' });

            const today = new Date().toLocaleDateString('en-AU', { timeZone: 'Australia/Sydney' });
            if (!questCompletion.fiveSales[sale.name][today]) {
                questCompletion.fiveSales[sale.name][today] = false;
                questCompletion.firstSale[today] = false;
                questCompletion.ageStreak[sale.name][today] = false;
                document.getElementById('quest-5-sales').classList.remove('completed');
                document.getElementById('quest-5-sales').textContent = 'Log 5 sales before 12:00 PM';
                document.getElementById('quest-first-sale').classList.remove('completed');
                document.getElementById('quest-first-sale').textContent = 'Make the first sale of the day';
                document.getElementById('quest-age-streak').classList.remove('completed');
                document.getElementById('quest-age-streak').textContent = '2-day streak with average donor age over 40';
            }

            const salesBeforeNoon = sales.filter(s => {
                const saleTime = new Date(s.timestamp);
                return s.name === sale.name && saleTime.getHours() < 12 && saleTime.toLocaleDateString('en-AU', { timeZone: 'Australia/Sydney' }) === date;
            }).length;
            if (salesBeforeNoon >= 5 && !questCompletion.fiveSales[sale.name][date]) {
                questCompletion.fiveSales[sale.name][date] = true;
                const quest = document.getElementById('quest-5-sales');
                quest.classList.add('completed');
                quest.textContent = `Log 5 sales before 12:00 PM (Completed by ${sale.name})`;
            }

            if (!questCompletion.firstSale[date]) {
                questCompletion.firstSale[date] = true;
                firstSaleToday[date] = sale;
                const quest = document.getElementById('quest-first-sale');
                quest.classList.add('completed');
                quest.textContent = `Make the first sale of the day (Completed by ${sale.name})`;
            }

            const todaySales = sales.filter(s => s.name === sale.name && s.timestamp.toLocaleDateString('en-AU', { timeZone: 'Australia/Sydney' }) === date);
            const todayAvgAge = todaySales.length > 0 ? todaySales.reduce((sum, s) => sum + s.age, 0) / todaySales.length : 0;
            if (todayAvgAge > 40) {
                const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000).toLocaleDateString('en-AU', { timeZone: 'Australia/Sydney' });
                const yesterdaySales = sales.filter(s => s.name === sale.name && s.timestamp.toLocaleDateString('en-AU', { timeZone: 'Australia/Sydney' }) === yesterday);
                const yesterdayAvgAge = yesterdaySales.length > 0 ? yesterdaySales.reduce((sum, s) => sum + s.age, 0) / yesterdaySales.length : 0;
                if (yesterdayAvgAge > 40 && !questCompletion.ageStreak[sale.name][date]) {
                    questCompletion.ageStreak[sale.name][date] = true;
                    const quest = document.getElementById('quest-age-streak');
                    quest.classList.add('completed');
                    quest.textContent = `2-day streak with average donor age over 40 (Completed by ${sale.name})`;
                }
            }
        }

        // Load data on page load
        window.onload = function() {
            loadSalesFromSheetDB();
        };
        // Optionally reload every 30 seconds for live leaderboard updates
        setInterval(loadSalesFromSheetDB, 30000);
    </script>
</body>
</html>
